# Matchminer Admin

This application provides automated processing of patient clinical, genomic, and trial data JSON files for the Matchminer system.

## Overview

The system processes JSON files from two main sources:

- **Patient Data JSON Files**: Generated by the [matchminer-patient](https://github.com/sumedhasaxena/matchminer-patient) repository, which provides a web interface for users to enter, review, and submit patient data
- **Trial Data JSON Files**: Generated by the [nct2ctml](https://github.com/sumedhasaxena/nct2ctml) repository or manually curated trial files

The system is designed to run as a Linux service with daily scheduling, ensuring reliable and automated data processing.

---

## 1. Setup

To get started with development, we need to set up an isolated Python environment. We can use either Python's built-in `venv` module or `conda`.

**Prerequisites:**
*   Git
*   Python 3.12
*   Anaconda or Miniconda (if using `conda`)

**Steps:**

1.  **Clone the repository:**
    ```bash
    git clone https://github.com/sumedhasaxena/matchminer-admin.git
    cd matchminer-admin
    ```

2.  **Create and activate the environment:**

    Choose one of the following options:

    **Option A: Using `venv` (standard Python)**

    a. **Create the virtual environment:**
    *   On **macOS and Linux**:
        ```bash
        python -m venv venv
        ```
    *   On **Windows**:
        ```bash
        python -m venv venv
        ```

    b. **Activate the virtual environment:**
    *   On **macOS and Linux**:
        ```bash
        source venv/bin/activate
        ```
    *   On **Windows**:
        ```bash
        .\venv\Scripts\activate
        ```
    ---
    **Option B: Using `conda`**

    a. **Create the Conda environment:**
    ```bash
    conda create --name matchminer-admin-env python=3.12
    ```
    
    b. **Activate the Conda environment:**
    ```bash
    conda activate matchminer-admin-env
    ```
---

## 2. Installing Dependencies

All the required Python packages are listed in the `requirements.txt` file.

With the correct environment activated, run the following command to install them:

```bash
pip install -r requirements.txt
```

---

## 3. Configuration Setup

Before running the application, you need to configure the Matchminer server connection details.

1.  **Create environment file from template:**
    
    **Use `.env.example` template file and copy it to create your environment file:**
    ```bash
    # For development
    cp .env.example .env.dev
    
    # For production server
    cp .env.example .env
    ```
    
2.  **Update following values in your newly created env file:**
    ```bash
    # For development
    vim .env.dev
    
    # For production
    vim .env
    ```    
    ```  
    # Matchminer server configuration
    MATCHMINER_SERVER=https://your-matchminer-server.com/
    TOKEN=your-authentication-token
    
    # Data source paths    
    
    # PATIENT_DATA_BASE_DIR=/path/to/matchminer-patient-repo
    # TRIAL_DATA_BASE_DIR=/path/to/nct2ctml-repo
    ```

**Note:** If you're setting up for the first time, you may also need to configure the trial environment settings. See the **Configuration Files** section below for details on `matchminer_trial_data_env_config.json`.

---

## 4. Running the Application Locally

Once the setup is complete and the dependencies are installed, you can run the file processor in different modes.

### **A. Run via python file**

```bash
python data_processor.py
```

Use this if the environment with required dependencies has already been setup and activated. This command will process all available patient and trial files from the path specified in .env file.

### **B. Run via shell script**

The shell script contains addition instructions to create an environment with required dependencies before running `python data_processor.py`
To run the data processor using the shell script:

```bash
# Run once and exit
./start_processor.sh
```

This will:
- Check all dependencies and configuration
- Process patient and trial files once and exit
- Show all processing messages in the terminal

### **C. Additional Manual Operations**

#### **Trial Operations:**

To process only trial files, use the follwing commands:

```bash
# Insert/update all trials from JSON files
python trial.py trial upsert

# Get trial by protocol number
python trial.py trial get --protocol_no 2024060101

# Update trial by protocol number
python trial.py trial update --protocol_no 2024060101 --updated_trial_file updated_trial.json

# Get max protocol_id and protocol_no from all trials
python trial.py system get_max_pid_pno

```

#### **Patient Operations:**

To process only patient files, use the follwing command:

```bash
# Process all patient clinical and genomic data
python patient.py
```
---

## 5. Application Flow

- **Patient files**
  - Read available clinical and genomic JSON files
  - Insert patient documents in Matchminer
  - Move the processed patient JSON files to a separate directory

- **Trial files**
  - Read `trial_status.csv`
  - For each row where `entry_last_updated_date` > last processed date (from `last_run_config.json`):
    - If `nct_id` is present (and not `NA`):
      - Look up trial in Matchminer by `nct_id`
      - If found, either:
            - close the trial in Matchminer, or
            - read corresponding JSON from `ctml/json` of nct2ctml repo and update trial (preserve existing `protocol_id`/`protocol_no`)
      - If not found: read corresponding JSON from `ctml/json` of nct2ctml repo and insert as new trial (auto-increment `protocol_id` and set `protocol_no` via date+counter)
    - If `nct_id` is missing/`NA` but `local_protocol_ids` present:
      - Look up trial by `local_protocol_ids`
      - Update if found; otherwise insert as new using the JSON
  - If any trial insert/update/close succeeds: run matchengine once to refresg patient-trial matches in matchminer DB
  - Save updated last processed dates to `last_run_config.json` for successfully processed trials

---

## 6. Deployment as a service on Linux

The service setup on Linux aims at running the workflow for both `nct2ctml` app and `matchminer_admin` app, in that sequence.
The script `sync_and_process.sh` has been created to sequenctially run both apps.

Follow the setup instructions above first, if its does not already exist on the linux server.

### **Deploy as Systemd Service:**

1.  **Make scripts executable:**
    ```bash
    chmod +x sync_and_process.sh
    chmod +x start_processor.sh
    chmod +x ../nct2ctml/sync_trials.sh
    ```

2.  **Copy service files to systemd directory:**
    ```bash
    sudo cp matchminer-admin.service /etc/systemd/system/
    sudo cp matchminer-admin.timer /etc/systemd/system/
    ```

3.  **Update service file paths:**
    ```bash
    sudo vim /etc/systemd/system/matchminer-admin.service
    ```
    
    Update the paths to match your installation:
    ```ini
    WorkingDirectory=/path/to/matchminer-admin
    ExecStart=/path/to/matchminer-admin/sync_and_process.sh
    ```

4.  **Enable and start the timer:**
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable matchminer-admin.timer
    sudo systemctl start matchminer-admin.timer
    ```

### **C. Verify Deployment:**

1.  **Check timer status:**
    ```bash
    sudo systemctl status matchminer-admin.timer
    ```

2.  **View service logs:**
    ```bash
    sudo journalctl -u matchminer-admin.service -f
    ```

3.  **Test manual execution:**
    ```bash
    sudo systemctl start matchminer-admin.service
    ```

### **D. Management Commands:**

**Check status:**
```bash
# Check timer status
sudo systemctl status matchminer-admin.timer

# Check service status
sudo systemctl status matchminer-admin.service
```

**View logs:**
```bash
sudo journalctl -u matchminer-admin.service -n 50
```

**Run manually:**
```bash
sudo systemctl start matchminer-admin.service
```

**Stop timer:**
```bash
sudo systemctl stop matchminer-admin.timer
sudo systemctl disable matchminer-admin.timer
```

---

## 7. Architecture Overview

The system has been redesigned for better reliability and maintainability:

### **Script Architecture:**

1. **`sync_and_process.sh`** - Master script that orchestrates the entire daily workflow
2. **`../nct2ctml/sync_trials.sh`** - Syncs trials from clinicaltrials.gov 
3. **`start_processor.sh`** - Processes patient and trial files

---

## 8. Additional Setup

### **Configuration Files**

This section explains the different configuration files used by the Matchminer Admin system.

#### **1. Trial Environment Configuration (`matchminer_trial_data_env_config.json`)**

This file contains auto-incrementing counters for trial protocol IDs and numbers. Every trial needs a unique `protocol_id` and `protocol_no` value to prevent conflicts in the database.

**Initial Setup for New Server Deployment:**

When deploying this app on a new server, you need to set the initial values in `matchminer_trial_data_env_config.json`:

**Step 1: Get Current Database Values**
Run this command to get the maximum values from your existing Matchminer database:
```bash
python trial.py get_max_pid_pno
```

This will return two values: `max_protocol_id` and `max_protocol_no`

**Step 2: Set Initial Configuration**
Create the config file with these values:
```json
{
    "protocol_id_counter": [max_protocol_id_from_step_1],
    "protocol_no_counter": "00",
    "current_date": null,
    "protocol_no": null
}
```

**Important Notes:**
- Set `protocol_id_counter` to the maximum protocol_id from your database
- Set `protocol_no_counter` to "00"
- Set `current_date` and `protocol_no` to `null` - the system will auto-populate these on first run

**Step 3: How It Works**
The system automatically:
- Increments `protocol_id_counter` by 1 for each new trial
- Creates protocol numbers in format: `YYYYMMDD + counter` (e.g., "2025082701")
- Resets the counter to "00" when the date changes
- Updates the config file after each successful trial insertion

**Example:** If your last trial has protocol_id 142, set `protocol_id_counter: 142`. The next trial will get protocol_id 143. 

**Example workflow:**
1. Run `python trial.py get_max_pid_pno` to get the current maximum protocol_id and protocol_no
2. Response : 143 2025082748
3. Set `protocol_id_counter` to 143 in the config file
4. The `protocol_no` in config should be either same as 'maximum protocol_no' returned by the command above, or set to null
4. The `protocol_no_counter` in config should be either same as last 2 digits of 'maximum protocol_no' returned by the command above, or set to null
5. The system will automatically increment protocol_id and protocol_no for each new trial inserted

#### **2. Environment Variables (`.env` file)**

These files contain environment-specific configuration:
- `MATCHMINER_SERVER`: Matchminer server URL
- `TOKEN`: Authentication token
- `PATIENT_DATA_BASE_DIR`: Path to matchminer-patient repository
- `TRIAL_DATA_BASE_DIR`: Path to nct2ctml repository
